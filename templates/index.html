{% extends "flex_layout.html" %}
{% block body %}
<style>
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Ubuntu';
  }
  p, div {
    font-family: 'Open Sans';
  }

  path {
    fill-opacity: 0;
  }
  * {
    box-sizing: border-box;
    }
    body.flexbox {
      display: flex;
      height: 90vh;
      flex-direction: column;
    }
    #flex_row {
      display: flex;
      flex-direction: row;
    }
    #left_col { 
      flex: 1;
    }
    #right_col { 
      flex: 0 0 250px;
      display: flex;
      flex-direction: column;
      min-height: 600px;
    }
    #panel3 { 
      flex: 0 0 300px;
    }
    #panel1 { 
      flex: 1;
    }
    #panel5 {
      flex: 0 0 300px;
    }
    #panel2 {
      flex: 1;
    }

    #panel5 h1, #panel3 h1 { margin-top: 0px; line-height: 90%;}

    #panel1 li { font-size: smaller; }
  #charts {
    padding: 10px 0;
  }

  .chart {
    display: inline-block;
    height: 131px;
    margin-bottom: 20px;
  }
  .chart#evolution-chart {
    height: 431px;
  }

  .reset {
    padding-left: 1em;
    font-size: smaller;
    color: #ccc;
  }

  .background.bar {
    fill: #ccc;
  }

  .foreground.bar {
    fill: steelblue;
  }

  .axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .axis text {
    font: 10px sans-serif;
  }

  .brush rect.extent {
    fill: steelblue;
    fill-opacity: .125;
  }

  .brush .resize path {
    fill: #eee;
    stroke: #666;
  }

  #hour-chart {
    width: 260px;
  }

  #no-members-chart {
    width: 230px;
  }

  #distance-chart {
    width: 420px;
  }

  #date-created-chart {
    width: 920px;
  }


  .list {
    line-height: 1.5em;
  }

  #groups-list div {
  }

  #groups-headers {
    font-weight: bold;
  }
  #groups-list a { text-decoration: none; }
  #groups-list a:hover { text-decoration: underline; }

  .list .date,
  .list .day {
    margin-bottom: .4em;
  }

  .list .group {
    margin-bottom: 1px;
  }

  .list .name {
    color: #000;
  }
  #groups-list  {
    color: #999;
  }

  .list .group div {
    display: inline-block;
    height: 22px;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100px;
  }
  .list .group div.name {
    width: 300px;
  }

  .list div.distance,
  .list div.no-member {
    width: 160px;
    padding-right: 10px;
    text-align: right;
  }

  .list .early {
    color: green;
  }

  aside {
    margin: 30px;
  }
  h1 { width: 80% }
  #totals { color: #ddd; font-size: 14px; font-weight: normal; }

  .dc-data-table { width: 1000px; color: #ddd; font-size: 14px; text-align:left;  }
</style>
<div id="flex_row">
  <div id="left_col">
    <div id="panel5">
      <h1>Evolution <small>of Meetup Groups </small><span id="totals">data loading</span></h1> 
      

    </div>
    <div id="panel2">
      <div id="evolution-chart" class="chart">
        <strong>Number of people who rsvped for events in this year</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:evolutionChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="date-created-chart" class="chart">
        <strong>Date group was created</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:dateCreatedChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>

    </div>
    <table class="table table-hover dc-data-table">
    </table>
  </div>
  <div id="right_col">

    <div id="panel3">
      <div id="no-members-chart" class="chart">
        <strong># Attendees</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noMembersChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="no-events-chart" class="chart">
        <strong># Events</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noEventsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div> 
    <div id="panel1">
      <p>Categories</p>
      <!--Adding all categories for selection-->
      <ul>
        <li><input type="checkbox" value="Tech" class="category_button"  id="tech" name="#a6cee3"> Tech</li>
        <li><input type="checkbox" value="Women" class="category_button" id="women" name = "#1f78b4"> Women</li>
        <li><input type="checkbox" value="Alternative lifesyle" class="category_button" id="alternative lifestyle" name = "#b2df8a"> Alternative lifesyle</li>
        <li><input type="checkbox" value="Career/Business" class="category_button" id="career/business" name = "#33a02c"> Career/Business</li>
        <li><input type="checkbox" value="Cars/Motorcycles" class="category_button" id="cars/motorcycles" name = "#fb9a99"> Cars/Motorcycles</li>
        <li><input type="checkbox" value="Community/Environment" class="category_button" id="community/environment" name = "#e31a1c"> Community/Environment </li>
        <li><input type="checkbox" value="dancing" class="category_button" id="dancing" name = "#fdbf6f"> Dancing </li>
        <li><input type="checkbox" value="Education/Learning" class="category_button" id="education/learning" name = "#ff7f00"> Education/Learning </li>
        <li><input type="checkbox" value="Fashion/Beauty" class="category_button" id="fashion/beauty" name = "#cab2d6"> Fashion/Beauty </li>
        <li><input type="checkbox" value="Fine Arts/Culture" class="category_button" id="fine arts/culture" name = "#6a3d9a"> Fine Arts/Culture</li>
        <li><input type="checkbox" value="Fitness" class="category_button" id="fitness" name = "#ffff99"> Fitness </li>
        <li><input type="checkbox" value="Food/Drink" class="category_button" id="food/drink" name = "#b15928"> Food/Drink </li>
        <li><input type="checkbox" value="Games" class="category_button" id="games" name = "#8dd3c7"> Games </li>
        <li><input type="checkbox" value="Health/Wellbeing" class="category_button" id="health/wellbeing" name = "#ffffb3"> Health/Wellbeing </li>
        <li><input type="checkbox" value="Hobbies/Crafts" class="category_button" id="hobbies/crafts" name = "#bebada"> Hobbies/Crafts </li>
        <li><input type="checkbox" value="Language/Ethnic Identity" class="category_button" id="language/Ethnic identity" name = "#cab2d6"> Language/Ethnic Identity </li>
        <li><input type="checkbox" value="LGBT" class="category_button" id="LGBT" name = "#fb8072"> LGBT </li>
        <li><input type="checkbox" value="Literature/Writing" class="category_button" id="literature/writing" name = "#80b1d3"> Literature/Writing </li>
        <li><input type="checkbox" value="Movements/Politics" class="category_button" id="movements/politics" name = "#fdb462"> Movements/Politics </li>
        <li><input type="checkbox" value="Movies/Film" class="category_button" id="movies/film" name = "#b3de69 "> Movies/Film </li>
        <li><input type="checkbox" value="Music" class="category_button" id="music" name = "#fccde5"> Music </li>
        <li><input type="checkbox" value="New Age/Spirituality" class="category_button" id="new age/spirituality" name = "#d9d9d9 "> New Age/Spirituality </li>
        <li><input type="checkbox" value="Outdoors/Adventure" class="category_button" id="outdoors/adventure" name = "#bc80bd"> Outdoors/Adventure </li>
        <li><input type="checkbox" value="Paranormal" class="category_button" id="paranormal" name = "#ccebc5"> Paranormal </li>
        <li><input type="checkbox" value="Parents/Family" class="category_button" id="parents/family" name = "#ffed6fs"> Parents/Family </li>
        <li><input type="checkbox" value="Pets/Animals" class="category_button" id="pets/animals" name = "#bf812d"> Pets/Animals </li>
        <li><input type="checkbox" value="Photography" class="category_button" id="photography" name = "#f6e8c3"> Photography </li>
        <li><input type="checkbox" value="Religion/Beliefs" class="category_button" id="religion/beliefs" name = "#c51b7d"> Religion/Beliefs </li>
        <li><input type="checkbox" value="Sci-Fi/Fantasy" class="category_button" id="sci-fi/fantasy" name = "#f1b6da"> Sci-Fi/Fantasy </li>
        <li><input type="checkbox" value="Singles" class="category_button" id="singles" name = "#e6f598"> Singles </li>
        <li><input type="checkbox" value="Socializing" class="category_button" id="socializing" name = "#01665e"> Socializing </li>
        <li><input type="checkbox" value="Sports/Recreation" class="category_button" id="sports/recreation" name = "#80cdc1"> Sports/Recreation </li>
        <li><input type="checkbox" value="Support" class="category_button" id="support" name = "#3288bd"> Support </li>
        <li><input type="checkbox" value="All" class="category_button" id="*" name = 'steelblue'> All </li>
        <li><input type="checkbox" value="None" class="category_button" id="" name = 'white'> None </li>
      </ul>
    </div>

  </div>
  </div>
  {% endblock %}
  {% block javascript %}
  <script>
    var groups, groups_by_month, groups_by_year, meetup, dataByGroup, date, dates, id_group, id_groups, nestByGroup; // make global for debugging



    function handle_csv(error, g, gm, gy) {
      console.log("got me some data");
      groups = g;
      groups_by_month = gm; // gm.slice(0,100);
      groups_by_year =  gy; // gy.slice(0,100);

      // Various formatters.
      formatInt = d3.format("f");
      formatNumber = d3.format(",d");
      formatChange = d3.format("+,d");
      formatCreated = d3.time.format("%Y-%m-%d %H:%M:%S");
      formatDate = d3.time.format("%Y-%m-%d");
      formatMonth = d3.time.format("%Y, %b");
      formatYearMonth = d3.time.format("%Y-%m");
      formatYear = d3.time.format("%Y");
      formatTime = d3.time.format("%I:%M %p");

      // A nest operator, for grouping the group list.
      nestByDate  = d3.nest().key(function(d) { return d3.time.month( d.date ); });

      // A little coercion, since the CSV is untyped.
      groups_by_year.forEach(function(d, i) {
        d.id_group = +d.id_group;
        d.sum = +d.sum;
        d.time_bin = formatCreated.parse( d.time_bin );
      });
      /*
      groups_by_month.forEach(function(d, i) {
        d.index = i;
        d.time_bin = formatCreated.parse( d.time_bin );
      });
      */
      groups.forEach(function(d, i) {
        d.index = i;
        d.date = formatDate.parse( d.created.substr(0,10) );
        d.first_event_time = formatCreated.parse( d.first_event_time );
        d.last_event_time = formatCreated.parse( d.last_event_time );
        d.id_gropu = +d.id_group;
        d.no_members = +d.no_members;
        d.number_of_events = +d.number_of_events;
        d.no_member_who_ever_rsvpd_yes = +d.no_member_who_ever_rsvpd_yes;
        d.max_yes_at_one_event = +d.max_yes_at_one_event;
        d.rating = parseFloat(d.rating);
        if (d.rating == 0.0) d.rating = null;
      });
      meetup = { 'evolution': {}, 'groups': {}};
      console.log("creating crossfilter for evolution:");
      meetup.evolution.cf = crossfilter(groups_by_year.slice(1,1000));

      meetup.evolution.group_and_date_dim   = meetup.evolution.cf.dimension(function(d) { return [d.id_group, d.time_bin]; });
      meetup.evolution.group_and_date_group = meetup.evolution.group_and_date_dim.group().reduceSum(function(d) { return d.sum; })

      console.log("creating chart for evolution:");
      var evolutionChart    = dc.seriesChart('#evolution-chart');
      evolutionChart.width(1000)
      .chart(function(c) { return dc.lineChart(c).interpolate('linear').renderArea(0).renderDataPoints(1).dotRadius(5); })
      .margins({top: 10, right: 10, bottom: 30, left: 40})
      .brushOn(0)
      .dimension(meetup.evolution.group_and_date_dim)
      .group(meetup.evolution.group_and_date_group)
      .x(d3.time.scale().domain([new Date(2001, 0, 1), new Date(2015, 3, 1)]).rangeRound([0, 10 * 90]))
      .seriesAccessor(function(d) {return +d.key[0];})
      .keyAccessor(function(d) {return +d.key[1];})
      .valueAccessor(function(d) {return +d.value;});

      console.log("rendering first thing");
      dc.renderAll();
      console.log("creating crossfilter for groups:");

      // Create the crossfilter for the relevant dimensions and groups.
      // var 
      meetup.groups.cf    = crossfilter(groups);

      meetup.groups.all    = meetup.groups.cf.groupAll();
      meetup.groups.id_dim = meetup.groups.cf.dimension(function(d) { return d.id_group; });

      meetup.groups.date_dim    = meetup.groups.cf.dimension(function(d) { return d.date; });
      meetup.groups.date_groups = meetup.groups.date_dim.group(d3.time.day);

      meetup.groups.hour_dim    = meetup.groups.cf.dimension(function(d) { return d.date.getHours() + d.date.getMinutes() / 60; });
      meetup.groups.hour_groups = meetup.groups.hour_dim.group(Math.floor);

      meetup.groups.no_member_dim    = meetup.groups.cf.dimension(function(d) { return d.no_member_who_ever_rsvpd_yes })
      meetup.groups.no_member_groups = meetup.groups.no_member_dim.group(function(d) { return Math.floor(d / 10) * 10; });

      meetup.groups.no_event_dim    = meetup.groups.cf.dimension(function(d) { return d.number_of_events });
      meetup.groups.no_event_groups = meetup.groups.no_event_dim.group(function(d) { return Math.floor(d / 10) * 10; });

      console.log("creating charts for groups:");
      var noMembersChart    = dc.barChart('#no-members-chart');
      var noEventsChart     = dc.barChart('#no-events-chart');
      var dateCreatedChart  = dc.barChart('#date-created-chart');
      var countWidget       = dc.dataCount('#totals');
      var listOfGroups      = dc.dataTable('.dc-data-table');

      countWidget.dimension(meetup.groups.cf).group(meetup.groups.all).html({
        some: '%filter-count of %total-count meetup groups selected',
        all: 'All meetup groups selected. Click on charts to apply filters'
      });

      noMembersChart.width(230)
      .height(100)
      .margins({top: 10, right: 10, bottom: 30, left: 40})
      .dimension(meetup.groups.no_member_dim)
      .group(meetup.groups.no_member_groups)
      .xUnits(dc.units.integers) 
      .filterPrinter(function (filters) {
        var filter = filters[0];
        return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
      })
      .x(d3.scale.linear().domain([0, 1500]).rangeRound([0, 10 * 21]));

      noMembersChart.xAxis().ticks(5);
      noMembersChart.yAxis().ticks(4);

      noEventsChart.width(230)
      .height(100)
      .margins({top: 10, right: 10, bottom: 30, left: 40})
      .dimension(meetup.groups.no_event_dim)
      .group(meetup.groups.no_event_groups)
      .xUnits(dc.units.integers) 
      .gap(1)
      .filterPrinter(function (filters) {
        var filter = filters[0];
        return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
      })
      .x(d3.scale.linear().domain([1, 200]).rangeRound([0, 10 * 20]));
      noEventsChart.xAxis().ticks(5);
      noEventsChart.yAxis().ticks(4);

      dateCreatedChart.width(1000)
      .dimension(meetup.groups.date_dim)
      .margins({top: 10, right: 10, bottom: 30, left: 40})
      .height(100)
      .group(meetup.groups.date_groups)
      .round(d3.time.day.round)
      .filterPrinter(function (filters) {
        var filter = filters[0];
        return "" + formatDate(filter[0]) + " to " + formatDate(filter[1]);
      })
      .x(d3.time.scale()
      .domain([new Date(2001, 0, 1), new Date(2015, 3, 1)])
      .rangeRound([0, 10 * 90]));

      listOfGroups.dimension(meetup.groups.date_dim)
      .group(function (d) { return d.date.getFullYear(); })
      .columns([
            'name',    
            'created',    
            'join_mode',    
            'max_yes_at_one_event',    
            'no_member_who_ever_rsvpd_yes',  
            'first_event_time',
            'no_events',
            'last_event_time'
      ])



      console.log("rendering all");
      dc.renderAll();

    }
    console.log("start loading data");
    queue()
    .defer(d3.csv, "/static/groups.csv")
    .defer(d3.csv, "/static/group-evolution-by-month.csv")
    .defer(d3.csv, "/static/group-evolution-by-year.csv")
    .await(handle_csv);
  </script>

  {% endblock %}
