{% extends "flex_layout.html" %}
{% block body %}
<div id="flex_row">
  <div id="left_col">
    <div id="panel5">
      <h1>Evolution <small>of Meetup Groups </small><span id="selected"></span><span id="totals"></span></h1> 
    </div>
    <div id="panel2">
      <div id="evolution-chart" class="chart">
        <strong>Number of people who rsvped for events in this year</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:evolutionChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="evolution-month-chart" class="chart">
        <strong>Number of people who rsvped for events in this month</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:evolutionMonthChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="date-created-chart" class="chart">
        <strong>Date group was created</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:dateCreatedChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div>
    <table class="table table-hover dc-data-table">
    </table>
  </div>
  <div id="right_col">
    <div id="panel3">
      <div id="no-members-chart" class="chart">
        <strong># Attendees</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noMembersChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="no-events-chart" class="chart">
        <strong># Events</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noEventsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div> 
    <div id="panel1">
      <div id="categories-chart" class="chart">
        <strong>Categories</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:categoriesChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script>
  /* Configuration for Charts */
  var max_data_lines = 10000; // of 149.613 static/group-evolution-by-month.csv
  var timeline_start = new Date(2002, 0, 1);
  var timeline_end   = new Date(2015, 0, 1);

  /* Global for reset-buttons */
  var evolutionChart      = dc.seriesChart('#evolution-chart');
  var evolutionMonthChart = dc.seriesChart('#evolution-month-chart');
  var noMembersChart    = dc.barChart('#no-members-chart');
  var noEventsChart     = dc.barChart('#no-events-chart');
  var dateCreatedChart  = dc.barChart('#date-created-chart');
  var categoriesChart   = dc.rowChart('#categories-chart');
  var selectedCounter   = dc.numberDisplay('#selected');
  var totalCounter      = dc.numberDisplay('#totals');
  var listOfGroups      = dc.dataTable('.dc-data-table');

/* Global for Debugging */
  var r1,r2,r3, pseudo;
  var groups, groups_by_month, groups_by_year, nest_by_group;   // raw data coming in
  var meetup = {               // namespace for crossfilter 
    'evolution': {}, 
    'evolution_by_month': {},
    'groups': {}
  }; 
</script>                                    
<script src="{{ url_for('static', filename='permalink.js') }}"></script>
<script>                                    
  function handle_csv(error, g) {
    var dataByGroup, date, dates, id_group, id_groups; // make global for debugging
    console.log("got me some data");
    // copy over to global variables
    groups = g.slice(0,max_data_lines);  // out of 141.616 static/groups-and-evolution.csv
    // Various formatters.
    formatInt       = d3.format("f");  // turn any number into integer by dropping digits after point
    formatNumber    = d3.format(",d");  // integer with comma to separate thousands: 1,000
    formatCreated   = d3.time.format("%Y-%m-%d %H:%M:%S");  // to parse dates coming in from csv / json
    formatDate      = d3.time.format("%Y-%m-%d");
    formatMonth     = d3.time.format("%Y, %b");
    formatYearMonth = d3.time.format("%Y-%m");
    formatYear      = d3.time.format("%Y");
    formatTime      = d3.time.format("%I:%M %p");

    category_for_group = {};
    groups.forEach(function(d, i) {
      d.index                = i;
      d.rating               = parseFloat(d.rating);
      d.created              = formatCreated.parse( d.created );
      d.first_event_time     = formatCreated.parse( d.first_event_time );
      d.last_event_time      = formatCreated.parse( d.last_event_time );
      d.time_bin             = formatCreated.parse( d.time_bin );
      d.time_bin_year        = formatCreated.parse( d.time_bin_year );
      d.no_members           = +d.no_members;
      d.number_of_events     = +d.number_of_events;
      d.max_yes_at_one_event = +d.max_yes_at_one_event;
      d.sum_rsvp_yes_in_time_bin = + d.sum_rsvp_yes_in_time_bin
      d.no_member_who_ever_rsvpd_yes = +d.no_member_who_ever_rsvpd_yes;
      category_for_group[ d.id_group ] = d.shortname_category;
      if (d.rating == 0.0) d.rating = null;
    });
    
    console.log("creating nested data:");

    nest_by_group = d3.nest().key(function(d){ return d.id_group; }).entries(groups).map(function(d) { return d.values[0] });

    // =======  helper functions for crossfilter  =========================================== 
    function reduceAddUniq(key) {
      return function(p, v) { 
        p[v[key]] = ( p[v[key]] || 0 ) + 1;
        return p; 
      }
    }
    function reduceRemoveUniq(key) {
      return function(p, v) { 
        p[v[key]] = ( p[v[key]] || 0 ) - 1;
        return p; 
      }
    }
    function reduceInitUniq(key) {
      return function () { return {}; }
    }
    r1 = reduceAddUniq("id_group");
    r2 = reduceRemoveUniq("id_group");
    r3 = reduceInitUniq("id_group");

    function count_uniq_group_ids_of_value(p) {
      return Math.floor( Object.keys(p.value).length );
    }
    function count_uniq_group_ids(p) {
      return Math.floor( Object.keys(p).length );
    }
    // =======  Groups  =========================================== 
    console.log("creating crossfilter for groups:");

    // Create the crossfilter for the relevant dimensions and groups.
    meetup.groups.cf                = crossfilter(groups);

    uniq_group_ids = meetup.groups.cf.groupAll().reduce( r1, r2, r3 );

    meetup.groups.all               = meetup.groups.cf.groupAll();
    meetup.groups.group_dim         = meetup.groups.cf.dimension(function(d) { return d.id_group; });
    meetup.groups.group_groups      = meetup.groups.group_dim.group().reduceCount();

    meetup.groups.created_dim       = meetup.groups.cf.dimension(function(d) { return d.created; });
    meetup.groups.created_groups    = meetup.groups.created_dim.group().reduce( r1, r2, r3 );

    meetup.groups.no_member_dim     = meetup.groups.cf.dimension(function(d) { return d.no_member_who_ever_rsvpd_yes })
    meetup.groups.no_member_groups  = meetup.groups.no_member_dim.group().reduce( r1, r2, r3 );

    meetup.groups.no_event_dim      = meetup.groups.cf.dimension(function(d) { return d.number_of_events });
    meetup.groups.no_event_groups   = meetup.groups.no_event_dim.group().reduce( r1, r2, r3 );

    meetup.groups.categories_dim    = meetup.groups.cf.dimension(function(d) { return d.shortname_category; });
    meetup.groups.categories_groups = meetup.groups.categories_dim.group().reduce( r1, r2, r3 );

    meetup.evolution.by_month_dim   = meetup.groups.cf.dimension(function(d) { return [d.id_group, d.time_bin]; });
    meetup.evolution.by_month_group = meetup.evolution.by_month_dim.group().reduceSum(function(d) { return d.sum_rsvp_yes_in_time_bin; })

    meetup.evolution.by_year_dim   = meetup.groups.cf.dimension(function(d) { return [d.id_group, d.time_bin_year]; });
    meetup.evolution.by_year_group = meetup.evolution.by_year_dim.group().reduceSum(function(d) { return d.sum_rsvp_yes_in_time_bin; })

    console.log("creating chart for evolution by year:");
    evolutionChart.width(1000)
    .chart(function(c) { return dc.lineChart(c).interpolate('linear').renderArea(0).renderDataPoints(1).dotRadius(5); })
    .margins({top: 10, right: 10, bottom: 30, left: 40})
    .brushOn(0)
    .dimension(meetup.evolution.by_year_dim)
    .group(meetup.evolution.by_year_group)
    .x(d3.time.scale().domain([timeline_start, timeline_end]).rangeRound([0, 10 * 90]))
    .seriesAccessor(function(d) {return +d.key[0];})
    .keyAccessor(   function(d) {return +d.key[1];})
    .valueAccessor( function(d) {return +d.value;})
    .on('postRender', function(chart){
      chart.selectAll("g.stack path").attr("class",        function(d){ return "category " + category_for_group[ d.name ]; })
      chart.selectAll("g.dc-tooltip circle").attr("class", function(d){ return "category " + category_for_group[ d.data.key[0]  ]; })
    })
    
    // =======  Evolution by Month =================================== 
    console.log("creating chart for evolution by month:");
    evolutionMonthChart.width(1000)
    .chart(function(c) { return dc.lineChart(c).interpolate('linear').renderArea(0).renderDataPoints(1).dotRadius(3); })
    .margins({top: 10, right: 10, bottom: 30, left: 40})
    .brushOn(0)
    .dimension(meetup.evolution.by_month_dim)
    .group(meetup.evolution.by_month_group)
    .x(d3.time.scale().domain([timeline_start, timeline_end]).rangeRound([0, 10 * 90]))
    .seriesAccessor(function(d) {return +d.key[0];})
    .keyAccessor(   function(d) {return +d.key[1];})
    .valueAccessor( function(d) {return +d.value;})
    .on('postRender', function(chart){
      chart.selectAll("g.stack path").attr("class",        function(d){ return "category " + category_for_group[ d.name ]; })
      chart.selectAll("g.dc-tooltip circle").attr("class", function(d){ return "category " + category_for_group[ d.data.key[0]  ]; })
    })

    console.log("creating charts for groups:");


    selectedCounter
    .valueAccessor(count_uniq_group_ids)
    .group(uniq_group_ids)
    .html({
      none: ' selected 0 of ',
      one: ' selected one of ',
      some: ' selected %number of ',
    })
    .formatNumber(d3.format("f"))
    ;

    totalCounter
    .valueAccessor(count_uniq_group_ids)
    .group(uniq_group_ids)
    .html({
      one: ' one meetup group',
      some: ' %number meetup groups',
    })
    .formatNumber(d3.format("f"))
    ;

    noMembersChart
    .valueAccessor(count_uniq_group_ids_of_value)
    .dimension(meetup.groups.no_member_dim)
    .group(meetup.groups.no_member_groups)
    .xUnits(dc.units.integers) 
    .width(230).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
    })
    .on('filtered', status_to_url)
    .x(d3.scale.linear().domain([0, 500]).rangeRound([0, 10 * 21]));

    noMembersChart.xAxis().ticks(5);
    noMembersChart.yAxis().ticks(4);

    noEventsChart
    .valueAccessor(count_uniq_group_ids_of_value)
    .dimension(meetup.groups.no_event_dim)
    .group(meetup.groups.no_event_groups)
    .xUnits(dc.units.integers) 
    .gap(1)
    .width(230).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
    })
    .on('filtered', status_to_url)
    .x(d3.scale.linear().domain([0,300]).rangeRound([0, 10 * 21]) );
    noEventsChart.xAxis().ticks(5);
    noEventsChart.yAxis().ticks(4);

    categoriesChart
    .valueAccessor(count_uniq_group_ids_of_value)
    .dimension(meetup.groups.categories_dim)
    .group(meetup.groups.categories_groups)
    .ordering(function(d){ return -d.value })
    .width(230).height(150).margins({top: 10, right: 10, bottom: 30, left: 40})
    .label(function (d) {
      return d.key + " (" + count_uniq_group_ids_of_value(d) + ")";
    })
    .title(function (d) {
      return d.value;
    })
    .on('postRender', function(chart){
      chart.selectAll("g.row rect").attr("class", function(d){ return "deselected category " + d.key; })
    })
    .elasticX(true)
    .on('filtered', status_to_url)
    .xAxis().ticks(4);

    dateCreatedChart
    .valueAccessor(count_uniq_group_ids_of_value)
    .dimension(meetup.groups.created_dim)
    .group(meetup.groups.created_groups)
    .width(1000).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .round(d3.time.day.round)
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatDate(filter[0]) + " to " + formatDate(filter[1]);
    })
    .on('filtered', status_to_url)
    .x(d3.time.scale().domain([timeline_start, timeline_end]).rangeRound([0, 10 * 90])); 
    dateCreatedChart.yAxis().ticks(5);

    pseudo = {};
    pseudo.top = function(x) { return nest_by_group.slice(0,x) };
    pseudo.bottom = function(x) { return nest_by_group.slice( nest_by_group.length-x ) };

    listOfGroups
    .dimension(pseudo)
    .group(function(d){ return "Selected Groups"; })
    .columns([
      { 'label': 'Group Name',     'format': function(d)  { return '<a href="/group/'+d.id_group+'">' + d.name + '</a>'   } },
      { 'label': 'Group Created',  'format': function(d)  { return formatYearMonth( d.created )     } },
      { 'label': 'Rating',         'format': function(d)  { return d.rating                         } },
      { 'label': 'Join Mode',      'format': function(d)  { return d.join_mode                      } },
      { 'label': 'Biggest Event',  'format': function(d)  { return d.max_yes_at_one_event           } },
      { 'label': 'Total Rsvps',    'format': function(d)  { return d.no_member_who_ever_rsvpd_yes   } },
      { 'label': 'First Event',    'format': function(d)  { return formatDate( d.first_event_time ) } },
      { 'label': '# Events',       'format': function(d)  { return d.number_of_events               } },
      { 'label': 'Last Event',     'format': function(d)  { return formatDate( d.last_event_time  ) } }
    ])

    console.log("rendering all");
    dc.renderAll();
    console.log("filtering from url");
    url_to_status();
    console.log("done.");

  }
  console.log("start loading data");
  queue()
  .defer(d3.csv,   "/static/g3.csv")
  .await(handle_csv);
</script>

{% endblock %}
