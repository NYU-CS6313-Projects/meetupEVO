{% extends "flex_layout.html" %}
{% block body %}
<div id="flex_row">
  <div id="left_col">
    <div id="panel5">
      <h1>Evolution <small>of Meetup Groups </small><span id="totals">data loading</span></h1> 
    </div>
    <div id="panel2">
      <div id="evolution-chart" class="chart">
        <strong>Number of people who rsvped for events in this year</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:evolutionChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="evolution-month-chart" class="chart">
        <strong>Number of people who rsvped for events in this month</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:evolutionMonthChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="date-created-chart" class="chart">
        <strong>Date group was created</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:dateCreatedChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div>
    <table class="table table-hover dc-data-table">
    </table>
  </div>
  <div id="right_col">
    <div id="panel3">
      <div id="no-members-chart" class="chart">
        <strong># Attendees</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noMembersChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
      <div id="no-events-chart" class="chart">
        <strong># Events</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:noEventsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div> 
    <div id="panel1">
      <div id="categories-chart" class="chart">
        <strong>Categories</strong>
        <span class="reset"><span class="filter"></span></span>
        <a class="reset" href="javascript:categoriesChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script>
  /* Configuration for Charts */
  var timeline_start = new Date(2002, 0, 1);
  var timeline_end   = new Date(2015, 0, 1);

  /* Global for reset-buttons */
  var evolutionChart      = dc.seriesChart('#evolution-chart');
  var evolutionMonthChart = dc.seriesChart('#evolution-month-chart');
  var noMembersChart    = dc.barChart('#no-members-chart');
  var noEventsChart     = dc.barChart('#no-events-chart');
  var dateCreatedChart  = dc.barChart('#date-created-chart');
  var categoriesChart   = dc.rowChart('#categories-chart');
  var countWidget       = dc.dataCount('#totals');
  var listOfGroups      = dc.dataTable('.dc-data-table');

/* Global for Debugging */
  var groups, groups_by_month, groups_by_year;   // raw data coming in
  var meetup = {               // namespace for crossfilter 
    'evolution': {}, 
    'evolution_by_month': {},
    'groups': {}
  }; 
                                      

  function handle_csv(error, g, gm, gy) {
    var dataByGroup, date, dates, id_group, id_groups, nestByGroup; // make global for debugging
    console.log("got me some data");
    // copy over to global variables
    groups = g;
    groups_by_month = gm; 
    groups_by_year =  gy;

    // Various formatters.
    formatInt       = d3.format("f");  // turn any number into integer by dropping digits after point
    formatNumber    = d3.format(",d");  // integer with comma to separate thousands: 1,000
    formatCreated   = d3.time.format("%Y-%m-%d %H:%M:%S");  // to parse dates coming in from csv / json
    formatDate      = d3.time.format("%Y-%m-%d");
    formatMonth     = d3.time.format("%Y, %b");
    formatYearMonth = d3.time.format("%Y-%m");
    formatYear      = d3.time.format("%Y");
    formatTime      = d3.time.format("%I:%M %p");

    // A little coercion, since the loaded JSON and CSV is untyped.
    groups_by_year.forEach(function(d, i) {
      d.id_group = +d.id_group;
      d.sum      = +d.sum;
      d.time_bin = formatCreated.parse( d.time_bin );  // time is already binned to 1.january of the year
    });
    groups_by_month.forEach(function(d, i) {
      d.index    = i;
      d.sum      = +d.sum;
      d.time_bin = formatCreated.parse( d.time_bin ); // time is already binned to 1st of the month
    });
    category_for_group = {};
    groups.forEach(function(d, i) {
      d.index                = i;
      d.rating               = parseFloat(d.rating);
      d.date                 = formatDate.parse( d.created.substr(0,10) );
      d.first_event_time     = formatCreated.parse( d.first_event_time );
      d.last_event_time      = formatCreated.parse( d.last_event_time );
      d.no_members           = +d.no_members;
      d.number_of_events     = +d.number_of_events;
      d.max_yes_at_one_event = +d.max_yes_at_one_event;
      d.no_member_who_ever_rsvpd_yes = +d.no_member_who_ever_rsvpd_yes;
      category_for_group[ d.id_group ] = d.shortname_category;
      if (d.rating == 0.0) d.rating = null;
    });

    // =======  Evolution  by Year==================================== 
    
    console.log("creating crossfilter for evolution by year:");
    meetup.evolution.cf = crossfilter(groups_by_year.slice(1,1000));

    meetup.evolution.group_and_date_dim   = meetup.evolution.cf.dimension(function(d) { return [d.id_group, d.time_bin]; });
    meetup.evolution.group_and_date_group = meetup.evolution.group_and_date_dim.group().reduceSum(function(d) { return d.sum; })

    console.log("creating chart for evolution:");
    evolutionChart.width(1000)
    .chart(function(c) { return dc.lineChart(c).interpolate('linear').renderArea(0).renderDataPoints(1).dotRadius(5); })
    .margins({top: 10, right: 10, bottom: 30, left: 40})
    .brushOn(0)
    .dimension(meetup.evolution.group_and_date_dim)
    .group(meetup.evolution.group_and_date_group)
    .x(d3.time.scale().domain([timeline_start, timeline_end]).rangeRound([0, 10 * 90]))
    .seriesAccessor(function(d) {return +d.key[0];})
    .keyAccessor(   function(d) {return +d.key[1];})
    .valueAccessor( function(d) {return +d.value;})
    .on('postRender', function(chart){
      chart.selectAll("g.stack path").attr("class",        function(d){ return "category " + category_for_group[ d.name ]; })
      chart.selectAll("g.dc-tooltip circle").attr("class", function(d){ return "category " + category_for_group[ d.data.key[0]  ]; })
    })
    
    // =======  Evolution by Month =================================== 
    console.log("creating crossfilter for evolution by month:");
    meetup.evolution_by_month.cf = crossfilter(groups_by_month.slice(1,1000));

    meetup.evolution_by_month.group_and_date_dim   = meetup.evolution_by_month.cf.dimension(function(d) { return [d.id_group, d.time_bin]; });
    meetup.evolution_by_month.group_and_date_group = meetup.evolution_by_month.group_and_date_dim.group().reduceSum(function(d) { return d.sum; })

    console.log("creating chart for evolution by month:");
    evolutionMonthChart.width(1000)
    .chart(function(c) { return dc.lineChart(c).interpolate('linear').renderArea(0).renderDataPoints(1).dotRadius(3); })
    .margins({top: 10, right: 10, bottom: 30, left: 40})
    .brushOn(0)
    .dimension(meetup.evolution_by_month.group_and_date_dim)
    .group(meetup.evolution_by_month.group_and_date_group)
    .x(d3.time.scale().domain([timeline_start, timeline_end]).rangeRound([0, 10 * 90]))
    .seriesAccessor(function(d) {return +d.key[0];})
    .keyAccessor(   function(d) {return +d.key[1];})
    .valueAccessor( function(d) {return +d.value;})
    .on('postRender', function(chart){
      chart.selectAll("g.stack path").attr("class",        function(d){ return "category " + category_for_group[ d.name ]; })
      chart.selectAll("g.dc-tooltip circle").attr("class", function(d){ return "category " + category_for_group[ d.data.key[0]  ]; })
    })

    // =======  Groups  =========================================== 
    console.log("creating crossfilter for groups:");

    // Create the crossfilter for the relevant dimensions and groups.
    meetup.groups.cf                = crossfilter(groups);

    meetup.groups.all               = meetup.groups.cf.groupAll();
    meetup.groups.id_dim            = meetup.groups.cf.dimension(function(d) { return d.id_group; });

    meetup.groups.date_dim          = meetup.groups.cf.dimension(function(d) { return d.date; });
    meetup.groups.date_groups       = meetup.groups.date_dim.group(d3.time.day);

    meetup.groups.hour_dim          = meetup.groups.cf.dimension(function(d) { return d.date.getHours() + d.date.getMinutes() / 60; });
    meetup.groups.hour_groups       = meetup.groups.hour_dim.group(Math.floor);

    meetup.groups.no_member_dim     = meetup.groups.cf.dimension(function(d) { return d.no_member_who_ever_rsvpd_yes })
    meetup.groups.no_member_groups  = meetup.groups.no_member_dim.group(function(d) { return Math.floor(d / 10) * 10; });

    meetup.groups.no_event_dim      = meetup.groups.cf.dimension(function(d) { return d.number_of_events });
    meetup.groups.no_event_groups   = meetup.groups.no_event_dim.group(function(d) { return Math.floor(d / 10) * 10; });

    meetup.groups.categories_dim    = meetup.groups.cf.dimension(function(d) { return d.shortname_category; });
    meetup.groups.categories_groups = meetup.groups.categories_dim.group();

    console.log("creating charts for groups:");

    countWidget.dimension(meetup.groups.cf).group(meetup.groups.all).html({
      some: '%filter-count of %total-count meetup groups selected',
      all: 'All meetup groups selected. Click on charts to apply filters'
    });

    noMembersChart
    .dimension(meetup.groups.no_member_dim)
    .group(meetup.groups.no_member_groups)
    .xUnits(dc.units.integers) 
    .width(230).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
    })
    .x(d3.scale.linear().domain([0, 1500]).rangeRound([0, 10 * 21]));

    noMembersChart.xAxis().ticks(5);
    noMembersChart.yAxis().ticks(4);

    noEventsChart
    .dimension(meetup.groups.no_event_dim)
    .group(meetup.groups.no_event_groups)
    .xUnits(dc.units.integers) 
    .gap(1)
    .width(230).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatInt(filter[0]) + "-" + formatInt(filter[1]);
    })
    .x(d3.scale.linear().domain([1, 200]).rangeRound([0, 10 * 20]));
    noEventsChart.xAxis().ticks(5);
    noEventsChart.yAxis().ticks(4);

    categoriesChart
    .dimension(meetup.groups.categories_dim)
    .group(meetup.groups.categories_groups)
    .ordering(function(d){ return -d.value })
    .width(230).height(1000).margins({top: 10, right: 10, bottom: 30, left: 40})
    .label(function (d) {
      return d.key + " (" + d.value + ")";
    })
    .title(function (d) {
      return d.value;
    })
    .on('postRender', function(chart){
      chart.selectAll("g.row rect").attr("class", function(d){ return "deselected category " + d.key; })
    })
    .elasticX(true)
    .xAxis().ticks(4);

    dateCreatedChart
    .dimension(meetup.groups.date_dim)
    .group(meetup.groups.date_groups)
    .width(1000).height(100).margins({top: 10, right: 10, bottom: 30, left: 40})
    .round(d3.time.day.round)
    .filterPrinter(function (filters) {
      var filter = filters[0];
      return "" + formatDate(filter[0]) + " to " + formatDate(filter[1]);
    })
    .x(d3.time.scale()
    .domain([timeline_start, timeline_end])
    .rangeRound([0, 10 * 90]));

    listOfGroups.dimension(meetup.groups.date_dim)
    .group(function (d) { return d.date.getFullYear(); })
    .columns([
          'name',    
          'created',    
          'join_mode',    
          'max_yes_at_one_event',    
          'no_member_who_ever_rsvpd_yes',  
          'first_event_time',
          'no_events',
          'last_event_time'
    ])

    console.log("rendering all");
    dc.renderAll();

  }
  console.log("start loading data");
  queue()
  .defer(d3.csv,   "/static/groups.csv")
  .defer(d3.csv,   "/static/group-evolution-by-month.csv")
  .defer(d3.csv,   "/static/group-evolution-by-year.csv")
  .await(handle_csv);
</script>

{% endblock %}
